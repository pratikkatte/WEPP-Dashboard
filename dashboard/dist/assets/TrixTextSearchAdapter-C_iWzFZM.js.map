{"version":3,"file":"TrixTextSearchAdapter-C_iWzFZM.js","sources":["../../node_modules/@gmod/trix/esm/index.js","../../node_modules/@jbrowse/plugin-trix/esm/TrixTextSearchAdapter/TrixTextSearchAdapter.js"],"sourcesContent":["import { Buffer } from 'buffer';\nconst CHUNK_SIZE = 65536;\n// this is the number of hex characters to use for the address in ixixx, see\n// https://github.com/GMOD/ixixx-js/blob/master/src/index.ts#L182\nconst ADDRESS_SIZE = 10;\n// https://stackoverflow.com/a/9229821/2129219\nfunction uniqBy(a, key) {\n    const seen = new Set();\n    return a.filter(item => {\n        const k = key(item);\n        return seen.has(k) ? false : seen.add(k);\n    });\n}\nexport default class Trix {\n    ixxFile;\n    ixFile;\n    maxResults;\n    constructor(ixxFile, ixFile, maxResults = 20) {\n        this.ixxFile = ixxFile;\n        this.ixFile = ixFile;\n        this.maxResults = maxResults;\n    }\n    async search(searchString, opts) {\n        let resultArr = [];\n        const searchWords = searchString.split(' ');\n        // we only search one word at a time\n        const searchWord = searchWords[0].toLowerCase();\n        const res = await this._getBuffer(searchWord, opts);\n        if (!res) {\n            return [];\n        }\n        let { end, buffer } = res;\n        let done = false;\n        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n        while (!done) {\n            let foundSomething = false;\n            const str = buffer.toString();\n            // slice to lastIndexOf('\\n') to make sure we get complete records\n            // since the buffer fetch could get halfway into a record\n            const lines = str\n                .slice(0, str.lastIndexOf('\\n'))\n                .split('\\n')\n                .filter(f => !!f);\n            const hits2 = [];\n            for (const line of lines) {\n                const word = line.split(' ')[0];\n                const match = word.startsWith(searchWord);\n                if (!foundSomething && match) {\n                    foundSomething = true;\n                }\n                // we are done scanning if we are lexicographically greater than the\n                // search string\n                if (word.slice(0, searchWord.length) > searchWord) {\n                    done = true;\n                }\n                if (match) {\n                    hits2.push(line);\n                }\n            }\n            const hits = hits2.flatMap(line => {\n                const [term, ...parts] = line.split(' ');\n                return parts.map(elt => [term, elt.split(',')[0]]);\n            });\n            // if we are not done, and we haven't filled up maxResults with hits yet,\n            // then refetch\n            if (resultArr.length + hits.length < this.maxResults && !done) {\n                const res2 = await this.ixFile.read(Buffer.alloc(CHUNK_SIZE), 0, CHUNK_SIZE, end, opts);\n                // early break if empty response\n                if (!res2.bytesRead) {\n                    resultArr = resultArr.concat(hits);\n                    break;\n                }\n                buffer = Buffer.concat([buffer, res2.buffer]);\n                end += CHUNK_SIZE;\n            }\n            // if we have filled up the hits, or we are detected to be done via the\n            // filtering, then return\n            else if (resultArr.length + hits.length >= this.maxResults || done) {\n                resultArr = resultArr.concat(hits);\n                break;\n            }\n        }\n        // deduplicate results based on the detail column (resultArr[1])\n        return uniqBy(resultArr, elt => elt[1]).slice(0, this.maxResults);\n    }\n    async getIndex(opts) {\n        const file = await this.ixxFile.readFile({\n            encoding: 'utf8',\n            ...opts,\n        });\n        return file\n            .split('\\n')\n            .filter(f => !!f)\n            .map(line => {\n            const p = line.length - ADDRESS_SIZE;\n            const prefix = line.slice(0, p);\n            const posStr = line.slice(p);\n            const pos = Number.parseInt(posStr, 16);\n            return [prefix, pos];\n        });\n    }\n    async _getBuffer(searchWord, opts) {\n        let start = 0;\n        let end = 65536;\n        const indexes = await this.getIndex(opts);\n        for (const [key, value] of indexes) {\n            const trimmedKey = key.slice(0, searchWord.length);\n            if (trimmedKey < searchWord) {\n                start = value;\n                end = value + 65536;\n            }\n        }\n        // Return the buffer and its end position in the file.\n        const len = end - start;\n        if (len < 0) {\n            return undefined;\n        }\n        const res = await this.ixFile.read(Buffer.alloc(len), 0, len, start, opts);\n        return {\n            ...res,\n            end,\n        };\n    }\n}\n//# sourceMappingURL=index.js.map","import Trix from '@gmod/trix';\nimport BaseResult from '@jbrowse/core/TextSearch/BaseResults';\nimport { readConfObject } from '@jbrowse/core/configuration';\nimport { BaseAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { openLocation } from '@jbrowse/core/util/io';\nfunction decodeURIComponentNoThrow(uri) {\n    try {\n        return decodeURIComponent(uri);\n    }\n    catch (e) {\n        return uri;\n    }\n}\nfunction shorten(str, term, w = 15) {\n    const tidx = str.toLowerCase().indexOf(term);\n    return str.length < 40\n        ? str\n        : (Math.max(0, tidx - w) > 0 ? '...' : '') +\n            str.slice(Math.max(0, tidx - w), tidx + term.length + w).trim() +\n            (tidx + term.length < str.length ? '...' : '');\n}\nexport default class TrixTextSearchAdapter extends BaseAdapter {\n    constructor(config, getSubAdapter, pluginManager) {\n        super(config, getSubAdapter, pluginManager);\n        const ixFilePath = readConfObject(config, 'ixFilePath');\n        const ixxFilePath = readConfObject(config, 'ixxFilePath');\n        if (!ixFilePath) {\n            throw new Error('must provide out.ix');\n        }\n        if (!ixxFilePath) {\n            throw new Error('must provide out.ixx');\n        }\n        this.trixJs = new Trix(openLocation(ixxFilePath, pluginManager), openLocation(ixFilePath, pluginManager), 1500);\n    }\n    async searchIndex(args) {\n        const query = args.queryString.toLowerCase();\n        const strs = query.split(' ');\n        const results = await this.trixJs.search(query);\n        const formatted = results\n            .filter(([, data]) => strs.every(r => decodeURIComponentNoThrow(data).toLowerCase().includes(r)))\n            .map(([term, data]) => {\n            const result = JSON.parse(data.replaceAll('|', ','));\n            const [loc, trackId, ...rest] = result.map(record => decodeURIComponentNoThrow(record));\n            const labelFieldIdx = rest.findIndex(elt => !!elt);\n            const contextIdx = rest\n                .map(elt => elt.toLowerCase())\n                .findIndex(f => f.includes(term.toLowerCase()));\n            const labelField = rest[labelFieldIdx];\n            const contextField = rest[contextIdx];\n            const context = contextIdx !== -1 ? shorten(contextField, term) : undefined;\n            const label = shorten(labelField, term);\n            const displayString = !context || label.toLowerCase() === context.toLowerCase()\n                ? label\n                : `${label} (${context})`;\n            return new BaseResult({\n                locString: loc,\n                label: labelField,\n                displayString,\n                matchedObject: result.map(record => decodeURIComponent(record)),\n                trackId,\n            });\n        });\n        return args.searchType === 'exact'\n            ? formatted.filter(r => r.getLabel().toLowerCase() === args.queryString.toLowerCase())\n            : formatted;\n    }\n    freeResources() { }\n}\n"],"names":["CHUNK_SIZE","ADDRESS_SIZE","uniqBy","a","key","seen","item","k","Trix","ixxFile","ixFile","maxResults","__publicField","searchString","opts","resultArr","searchWord","res","end","buffer","done","str","lines","f","hits2","line","word","match","hits","term","parts","elt","res2","Buffer","p","prefix","posStr","pos","start","indexes","value","len","decodeURIComponentNoThrow","uri","shorten","w","tidx","TrixTextSearchAdapter","BaseAdapter","config","getSubAdapter","pluginManager","ixFilePath","readConfObject","ixxFilePath","openLocation","args","query","strs","formatted","data","r","result","loc","trackId","rest","record","labelFieldIdx","contextIdx","labelField","contextField","context","label","displayString","BaseResult"],"mappings":"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","x_google_ignoreList":[0,1]}