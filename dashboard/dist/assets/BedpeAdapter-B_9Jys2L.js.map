{"version":3,"file":"BedpeAdapter-B_9Jys2L.js","sources":["../../node_modules/@jbrowse/plugin-bed/esm/BedpeAdapter/BedpeAdapter.js"],"sourcesContent":["import IntervalTree from '@flatten-js/interval-tree';\nimport { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { SimpleFeature, fetchAndMaybeUnzip } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nconst svTypes = new Set(['DUP', 'TRA', 'INV', 'CNV', 'DEL']);\nexport function featureData(line, uniqueId, flip, names) {\n    const l = line.split('\\t');\n    const ref1 = l[flip ? 3 : 0];\n    const start1 = +l[flip ? 4 : 1];\n    const end1 = +l[flip ? 5 : 2];\n    const ref2 = l[!flip ? 3 : 0];\n    const start2 = +l[!flip ? 4 : 1];\n    const end2 = +l[!flip ? 5 : 2];\n    const name = l[6];\n    const score = +l[7];\n    const strand1 = parseStrand(l[8]);\n    const strand2 = parseStrand(l[9]);\n    const extra = l.slice(10);\n    const rest = names\n        ? Object.fromEntries(names.slice(10).map((n, idx) => [n, extra[idx]]))\n        : extra;\n    const ALT = svTypes.has(extra[0]) ? `<${extra[0]}>` : undefined;\n    return new SimpleFeature({\n        ...rest,\n        start: start1,\n        end: end1,\n        type: 'paired_feature',\n        refName: ref1,\n        strand: strand1,\n        name,\n        score,\n        uniqueId,\n        mate: {\n            refName: ref2,\n            start: start2,\n            end: end2,\n            strand: strand2,\n        },\n        ...(ALT ? { ALT: [ALT] } : {}),\n    });\n}\nfunction parseStrand(strand) {\n    if (strand === '+') {\n        return 1;\n    }\n    if (strand === '-') {\n        return -1;\n    }\n    if (strand === '.') {\n        return 0;\n    }\n    return undefined;\n}\nclass BedpeAdapter extends BaseFeatureDataAdapter {\n    constructor() {\n        super(...arguments);\n        this.intervalTrees = {};\n    }\n    async loadDataP(opts) {\n        const pm = this.pluginManager;\n        const bedLoc = this.getConf('bedpeLocation');\n        const loc = openLocation(bedLoc, pm);\n        const buffer = await fetchAndMaybeUnzip(loc, opts);\n        if (buffer.length > 536870888) {\n            throw new Error('Data exceeds maximum string length (512MB)');\n        }\n        const data = new TextDecoder('utf8', { fatal: true }).decode(buffer);\n        const lines = data.split(/\\n|\\r\\n|\\r/).filter(f => !!f);\n        const headerLines = [];\n        let i = 0;\n        for (; i < lines.length && lines[i].startsWith('#'); i++) {\n            headerLines.push(lines[i]);\n        }\n        const header = headerLines.join('\\n');\n        const feats1 = {};\n        const feats2 = {};\n        for (; i < lines.length; i++) {\n            const line = lines[i];\n            const cols = line.split('\\t');\n            const r1 = cols[0];\n            const r2 = cols[3];\n            if (!feats1[r1]) {\n                feats1[r1] = [];\n            }\n            if (!feats2[r2]) {\n                feats2[r2] = [];\n            }\n            feats1[r1].push(line);\n            feats2[r2].push(line);\n        }\n        const columnNames = this.getConf('columnNames');\n        return {\n            header,\n            feats1,\n            feats2,\n            columnNames,\n        };\n    }\n    async loadData(opts = {}) {\n        if (!this.bedpeFeatures) {\n            this.bedpeFeatures = this.loadDataP(opts).catch((e) => {\n                this.bedpeFeatures = undefined;\n                throw e;\n            });\n        }\n        return this.bedpeFeatures;\n    }\n    async getRefNames(opts = {}) {\n        const { feats1, feats2 } = await this.loadData(opts);\n        return [...new Set([...Object.keys(feats1), ...Object.keys(feats2)])];\n    }\n    async getHeader(opts = {}) {\n        const { header } = await this.loadData(opts);\n        return header;\n    }\n    async getNames() {\n        const { header, columnNames } = await this.loadData();\n        if (columnNames.length) {\n            return columnNames;\n        }\n        const defs = header.split(/\\n|\\r\\n|\\r/).filter(f => !!f);\n        const defline = defs.at(-1);\n        return (defline === null || defline === void 0 ? void 0 : defline.includes('\\t'))\n            ? defline\n                .slice(1)\n                .split('\\t')\n                .map(field => field.trim())\n            : undefined;\n    }\n    async loadFeatureTreeP(refName) {\n        var _a, _b, _c, _d;\n        const { feats1, feats2 } = await this.loadData();\n        const names = await this.getNames();\n        const intervalTree = new IntervalTree();\n        const ret1 = (_b = (_a = feats1[refName]) === null || _a === void 0 ? void 0 : _a.map((f, i) => featureData(f, `${this.id}-${refName}-${i}-r1`, false, names))) !== null && _b !== void 0 ? _b : [];\n        const ret2 = (_d = (_c = feats2[refName]) === null || _c === void 0 ? void 0 : _c.map((f, i) => featureData(f, `${this.id}-${refName}-${i}-r2`, true, names))) !== null && _d !== void 0 ? _d : [];\n        for (const obj of [...ret1, ...ret2]) {\n            intervalTree.insert([obj.get('start'), obj.get('end')], obj);\n        }\n        return intervalTree;\n    }\n    async loadFeatureTree(refName) {\n        if (!this.intervalTrees[refName]) {\n            this.intervalTrees[refName] = this.loadFeatureTreeP(refName).catch((e) => {\n                this.intervalTrees[refName] = undefined;\n                throw e;\n            });\n        }\n        return this.intervalTrees[refName];\n    }\n    getFeatures(query, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            const { start, end, refName } = query;\n            const intervalTree = await this.loadFeatureTree(refName);\n            intervalTree === null || intervalTree === void 0 ? void 0 : intervalTree.search([start, end]).forEach(f => {\n                observer.next(f);\n            });\n            observer.complete();\n        }, opts.stopToken);\n    }\n    freeResources() { }\n}\nBedpeAdapter.capabilities = ['getFeatures', 'getRefNames'];\nexport default BedpeAdapter;\n"],"names":["svTypes","featureData","line","uniqueId","flip","names","l","ref1","start1","end1","ref2","start2","end2","name","score","strand1","parseStrand","strand2","extra","rest","n","idx","ALT","SimpleFeature","strand","BedpeAdapter","BaseFeatureDataAdapter","opts","pm","bedLoc","loc","openLocation","buffer","fetchAndMaybeUnzip","lines","f","headerLines","header","feats1","feats2","cols","r1","r2","columnNames","e","defline","field","refName","_a","_b","_c","_d","intervalTree","IntervalTree","ret1","i","ret2","obj","query","ObservableCreate","observer","start","end"],"mappings":"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","x_google_ignoreList":[0]}