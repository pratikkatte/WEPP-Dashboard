{"version":3,"file":"VcfTabixAdapter-CzTLjEGP.js","sources":["../../node_modules/@jbrowse/plugin-variants/esm/VcfTabixAdapter/VcfTabixAdapter.js"],"sourcesContent":["import { TabixIndexedFile } from '@gmod/tabix';\nimport VcfParser from '@gmod/vcf';\nimport { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport VcfFeature from '../VcfFeature';\nexport default class VcfTabixAdapter extends BaseFeatureDataAdapter {\n    async configurePre() {\n        const pm = this.pluginManager;\n        const vcfGzLocation = this.getConf('vcfGzLocation');\n        const location = this.getConf(['index', 'location']);\n        const indexType = this.getConf(['index', 'indexType']);\n        const filehandle = openLocation(vcfGzLocation, pm);\n        const isCSI = indexType === 'CSI';\n        const vcf = new TabixIndexedFile({\n            filehandle,\n            csiFilehandle: isCSI ? openLocation(location, pm) : undefined,\n            tbiFilehandle: !isCSI ? openLocation(location, pm) : undefined,\n            chunkCacheSize: 50 * 2 ** 20,\n        });\n        const header = await vcf.getHeader();\n        return {\n            vcf,\n            parser: new VcfParser({ header }),\n        };\n    }\n    async configure() {\n        if (!this.configured) {\n            this.configured = this.configurePre().catch((e) => {\n                this.configured = undefined;\n                throw e;\n            });\n        }\n        return this.configured;\n    }\n    async getRefNames(opts = {}) {\n        const { vcf } = await this.configure();\n        return vcf.getReferenceSequenceNames(opts);\n    }\n    async getHeader() {\n        const { vcf } = await this.configure();\n        return vcf.getHeader();\n    }\n    async getMetadata() {\n        const { parser } = await this.configure();\n        return parser.getMetadata();\n    }\n    getFeatures(query, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            const { refName, start, end } = query;\n            const { vcf, parser } = await this.configure();\n            await vcf.getLines(refName, start, end, {\n                lineCallback: (line, fileOffset) => {\n                    observer.next(new VcfFeature({\n                        variant: parser.parseLine(line),\n                        parser,\n                        id: `${this.id}-vcf-${fileOffset}`,\n                    }));\n                },\n                ...opts,\n            });\n            observer.complete();\n        }, opts.stopToken);\n    }\n    async getSources() {\n        const { parser } = await this.configure();\n        return parser.samples.map(name => ({\n            name,\n        }));\n    }\n    freeResources() { }\n}\n"],"names":["VcfTabixAdapter","BaseFeatureDataAdapter","pm","vcfGzLocation","location","indexType","filehandle","openLocation","isCSI","vcf","TabixIndexedFile","header","VcfParser","opts","parser","query","ObservableCreate","observer","refName","start","end","line","fileOffset","VcfFeature","name"],"mappings":"0NAMe,MAAMA,UAAwBC,EAAAA,sBAAuB,CAChE,MAAM,cAAe,CACjB,MAAMC,EAAK,KAAK,cACVC,EAAgB,KAAK,QAAQ,eAAe,EAC5CC,EAAW,KAAK,QAAQ,CAAC,QAAS,UAAU,CAAC,EAC7CC,EAAY,KAAK,QAAQ,CAAC,QAAS,WAAW,CAAC,EAC/CC,EAAaC,EAAAA,aAAaJ,EAAeD,CAAE,EAC3CM,EAAQH,IAAc,MACtBI,EAAM,IAAIC,EAAiB,CAC7B,WAAAJ,EACA,cAAeE,EAAQD,EAAAA,aAAaH,EAAUF,CAAE,EAAI,OACpD,cAAgBM,EAAqC,OAA7BD,EAAAA,aAAaH,EAAUF,CAAE,EACjD,eAAgB,GAAK,GAAK,EACtC,CAAS,EACKS,EAAS,MAAMF,EAAI,UAAW,EACpC,MAAO,CACH,IAAAA,EACA,OAAQ,IAAIG,EAAU,CAAE,OAAAD,EAAQ,CACnC,CACT,CACI,MAAM,WAAY,CACd,OAAK,KAAK,aACN,KAAK,WAAa,KAAK,aAAY,EAAG,MAAO,GAAM,CAC/C,WAAK,WAAa,OACZ,CACtB,CAAa,GAEE,KAAK,UACpB,CACI,MAAM,YAAYE,EAAO,GAAI,CACzB,KAAM,CAAE,IAAAJ,CAAG,EAAK,MAAM,KAAK,UAAW,EACtC,OAAOA,EAAI,0BAA0BI,CAAI,CACjD,CACI,MAAM,WAAY,CACd,KAAM,CAAE,IAAAJ,CAAG,EAAK,MAAM,KAAK,UAAW,EACtC,OAAOA,EAAI,UAAW,CAC9B,CACI,MAAM,aAAc,CAChB,KAAM,CAAE,OAAAK,CAAM,EAAK,MAAM,KAAK,UAAW,EACzC,OAAOA,EAAO,YAAa,CACnC,CACI,YAAYC,EAAOF,EAAO,GAAI,CAC1B,OAAOG,EAAAA,iBAAiB,MAAOC,GAAa,CACxC,KAAM,CAAE,QAAAC,EAAS,MAAAC,EAAO,IAAAC,CAAK,EAAGL,EAC1B,CAAE,IAAAN,EAAK,OAAAK,CAAQ,EAAG,MAAM,KAAK,UAAW,EAC9C,MAAML,EAAI,SAASS,EAASC,EAAOC,EAAK,CACpC,aAAc,CAACC,EAAMC,IAAe,CAChCL,EAAS,KAAK,IAAIM,EAAW,CACzB,QAAST,EAAO,UAAUO,CAAI,EAC9B,OAAAP,EACA,GAAI,GAAG,KAAK,EAAE,QAAQQ,CAAU,EACxD,CAAqB,CAAC,CACL,EACD,GAAGT,CACnB,CAAa,EACDI,EAAS,SAAU,CAC/B,EAAWJ,EAAK,SAAS,CACzB,CACI,MAAM,YAAa,CACf,KAAM,CAAE,OAAAC,CAAM,EAAK,MAAM,KAAK,UAAW,EACzC,OAAOA,EAAO,QAAQ,IAAIU,IAAS,CAC/B,KAAAA,CACZ,EAAU,CACV,CACI,eAAgB,CAAA,CACpB","x_google_ignoreList":[0]}