import{aP as C,aQ as T,ac as p,u as g,aa as L,ab as _,G as b,aR as P,aS as I}from"./index-BF7YmVSy.js";import{B as R}from"./bamFile-D1p3LXXM.js";import{B as A}from"./index-vSQaLnMA.js";import{Q as E}from"./QuickLRU--E2pQBll.js";import{r as $}from"./rxjs-Cp1IxKah.js";import"./crc32-BNrRoR32.js";class S{constructor(e,t,a){this.record=e,this.adapter=t,this.ref=a}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return C(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var e;return(e=this.record.qual)===null||e===void 0?void 0:e.join(" ")}get(e){return e==="mismatches"?this.mismatches:e==="qual"?this.qual:this.fields[e]}parent(){}children(){}get fields(){const e=this.record,t=this.adapter,a=e.isPaired();return{start:e.start,name:e.name,end:e.end,score:e.score,strand:e.strand,template_length:e.template_length,flags:e.flags,tags:e.tags,refName:t.refIdToName(e.ref_id),CIGAR:e.CIGAR,seq:e.seq,type:"match",pair_orientation:e.pair_orientation,next_ref:a?t.refIdToName(e.next_refid):void 0,next_pos:a?e.next_pos:void 0,next_segment_position:a?`${t.refIdToName(e.next_refid)}:${e.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}T(S,"fields");T(S,"mismatches");class G extends A.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new E({maxSize:500})}async configurePre(){const e=this.getConf("bamLocation"),t=this.getConf(["index","location"]),a=this.getConf(["index","indexType"]),n=this.pluginManager,i=a==="CSI",u=new R({bamFilehandle:p.openLocation(e,n),csiFilehandle:i?p.openLocation(t,n):void 0,baiFilehandle:i?void 0:p.openLocation(t,n),yieldThreadTime:Number.POSITIVE_INFINITY}),o=this.getConf("sequenceAdapter");if(o&&this.getSubAdapter){const{dataAdapter:c}=await this.getSubAdapter(o);return{bam:u,sequenceAdapter:c}}return{bam:u}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(e=>{throw this.configureP=void 0,e})),this.configureP}async getHeader(e){const{bam:t}=await this.configure();return t.getHeaderText()}async setupPre(e){const{statusCallback:t=()=>{}}=e||{},{bam:a}=await this.configure();return this.samHeader=await g.updateStatus("Downloading index",t,async()=>{const n=await a.getHeader(),i=[],u={};return n==null||n.filter(o=>o.tag==="SQ").forEach((o,c)=>{const r=o.data.find(s=>s.tag==="SN");if(r){const s=r.value;u[s]=c,i[c]=s}}),{idToName:i,nameToId:u}}),this.samHeader}async setup(e){return this.setupP||(this.setupP=this.setupPre(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async getRefNames(e){const{idToName:t}=await this.setup(e);return t}async seqFetch(e,t,a){const{sequenceAdapter:n}=await this.configure(),i=n;if(!i||!e)return;const u=i.getFeatures({refName:e,start:t,end:a,assemblyName:""}),o=await L(u.pipe(_()));let c="";if(o.sort((r,s)=>r.get("start")-s.get("start")).forEach(r=>{const s=r.get("start"),l=r.get("end"),h=Math.max(t-s,0),m=Math.min(a-s,l-s)-h,f=r.get("seq")||r.get("residues");c+=f.slice(h,h+m)}),c.length!==a-t)throw new Error(`sequence fetch failed: fetching ${e}:${(t-1).toLocaleString()}-${a.toLocaleString()} returned ${c.length.toLocaleString()} bases, but should have returned ${(a-t).toLocaleString()}`);return c}getFeatures(e,t){const{refName:a,start:n,end:i,originalRefName:u}=e,{stopToken:o,filterBy:c,statusCallback:r=()=>{}}=t||{};return $.ObservableCreate(async s=>{const{bam:l}=await this.configure();await this.setup(t),b.checkStopToken(o);const h=await g.updateStatus("Downloading alignments",r,()=>l.getRecordsForRange(a,n,i));b.checkStopToken(o),await g.updateStatus("Processing alignments",r,async()=>{const{flagInclude:x=0,flagExclude:m=0,tagFilter:f,readName:w}=c||{};for(const d of h){let y;if(d.tags.MD||(y=await this.seqFetch(u||a,d.start,d.end)),P(d.flags,x,m)||f&&I(d.tags[f.tag],f.value)||w&&d.name!==w)continue;const q=this.ultraLongFeatureCache.get(`${d.id}`);if(q)s.next(q);else{const F=new S(d,this,y);this.ultraLongFeatureCache.set(`${d.id}`,F),s.next(F)}}s.complete()})})}async getMultiRegionFeatureDensityStats(e,t){const{bam:a}=await this.configure();if(a.index){const n=await g.bytesForRegions(e,a),i=this.getConf("fetchSizeLimit");return{bytes:n,fetchSizeLimit:i}}return super.getMultiRegionFeatureDensityStats(e,t)}freeResources(){}refIdToName(e){var t;return(t=this.samHeader)===null||t===void 0?void 0:t.idToName[e]}}export{G as default};
//# sourceMappingURL=BamAdapter-BxAPW07Z.js.map
