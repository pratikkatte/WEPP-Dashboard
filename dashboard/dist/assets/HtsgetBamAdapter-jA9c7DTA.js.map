{"version":3,"file":"HtsgetBamAdapter-jA9c7DTA.js","sources":["../../node_modules/@gmod/bam/esm/htsget.js","../../node_modules/@jbrowse/plugin-alignments/esm/HtsgetBamAdapter/HtsgetBamAdapter.js"],"sourcesContent":["import { unzip } from '@gmod/bgzf-filehandle';\nimport { Buffer } from 'buffer';\nimport BamFile, { BAM_MAGIC } from './bamFile';\nimport { parseHeaderText } from './sam';\nasync function concat(arr, opts) {\n    const res = await Promise.all(arr.map(async (chunk) => {\n        const { url, headers } = chunk;\n        if (url.startsWith('data:')) {\n            return Buffer.from(url.split(',')[1], 'base64');\n        }\n        else {\n            //remove referer header, it is not even allowed to be specified\n            // @ts-expect-error\n            const { referer, ...rest } = headers;\n            const res = await fetch(url, {\n                ...opts,\n                headers: { ...opts === null || opts === void 0 ? void 0 : opts.headers, ...rest },\n            });\n            if (!res.ok) {\n                throw new Error(`HTTP ${res.status} fetching ${url}: ${await res.text()}`);\n            }\n            return Buffer.from(await res.arrayBuffer());\n        }\n    }));\n    return Buffer.concat(await Promise.all(res.map(elt => unzip(elt))));\n}\nexport default class HtsgetFile extends BamFile {\n    constructor(args) {\n        super({ htsget: true });\n        this.baseUrl = args.baseUrl;\n        this.trackId = args.trackId;\n    }\n    async *streamRecordsForRange(chr, min, max, opts) {\n        var _a;\n        const base = `${this.baseUrl}/${this.trackId}`;\n        const url = `${base}?referenceName=${chr}&start=${min}&end=${max}&format=BAM`;\n        const chrId = (_a = this.chrToIndex) === null || _a === void 0 ? void 0 : _a[chr];\n        if (chrId === undefined) {\n            yield [];\n        }\n        else {\n            const result = await fetch(url, { ...opts });\n            if (!result.ok) {\n                throw new Error(`HTTP ${result.status} fetching ${url}: ${await result.text()}`);\n            }\n            const data = await result.json();\n            const uncba = await concat(data.htsget.urls.slice(1), opts);\n            yield* this._fetchChunkFeatures([\n                // fake stuff to pretend to be a Chunk\n                {\n                    buffer: uncba,\n                    _fetchedSize: undefined,\n                    bin: 0,\n                    compareTo() {\n                        return 0;\n                    },\n                    toUniqueString() {\n                        return `${chr}_${min}_${max}`;\n                    },\n                    fetchedSize() {\n                        return 0;\n                    },\n                    minv: {\n                        dataPosition: 0,\n                        blockPosition: 0,\n                        compareTo: () => 0,\n                    },\n                    maxv: {\n                        dataPosition: Number.MAX_SAFE_INTEGER,\n                        blockPosition: 0,\n                        compareTo: () => 0,\n                    },\n                    toString() {\n                        return `${chr}_${min}_${max}`;\n                    },\n                },\n            ], chrId, min, max, opts);\n        }\n    }\n    async _readChunk({ chunk }) {\n        if (!chunk.buffer) {\n            throw new Error('expected chunk.buffer in htsget');\n        }\n        return { data: chunk.buffer, cpositions: [], dpositions: [], chunk };\n    }\n    async getHeader(opts = {}) {\n        const url = `${this.baseUrl}/${this.trackId}?referenceName=na&class=header`;\n        const result = await fetch(url, opts);\n        if (!result.ok) {\n            throw new Error(`HTTP ${result.status} fetching ${url}: ${await result.text()}`);\n        }\n        const data = await result.json();\n        const uncba = await concat(data.htsget.urls, opts);\n        if (uncba.readInt32LE(0) !== BAM_MAGIC) {\n            throw new Error('Not a BAM file');\n        }\n        const headLen = uncba.readInt32LE(4);\n        const headerText = uncba.toString('utf8', 8, 8 + headLen);\n        const samHeader = parseHeaderText(headerText);\n        // use the @SQ lines in the header to figure out the\n        // mapping between ref ref ID numbers and names\n        const idToName = [];\n        const nameToId = {};\n        const sqLines = samHeader.filter(l => l.tag === 'SQ');\n        for (const [refId, sqLine] of sqLines.entries()) {\n            let refName = '';\n            let length = 0;\n            for (const item of sqLine.data) {\n                if (item.tag === 'SN') {\n                    refName = item.value;\n                }\n                else if (item.tag === 'LN') {\n                    length = +item.value;\n                }\n            }\n            nameToId[refName] = refId;\n            idToName[refId] = { refName, length };\n        }\n        this.chrToIndex = nameToId;\n        this.indexToChr = idToName;\n        return samHeader;\n    }\n}\n//# sourceMappingURL=htsget.js.map","import { HtsgetFile } from '@gmod/bam';\nimport BamAdapter from '../BamAdapter/BamAdapter';\nexport default class HtsgetBamAdapter extends BamAdapter {\n    async configurePre() {\n        const htsgetBase = this.getConf('htsgetBase');\n        const htsgetTrackId = this.getConf('htsgetTrackId');\n        const bam = new HtsgetFile({\n            baseUrl: htsgetBase,\n            trackId: htsgetTrackId,\n        });\n        const adapterConfig = this.getConf('sequenceAdapter');\n        if (adapterConfig && this.getSubAdapter) {\n            const adapter = await this.getSubAdapter(adapterConfig);\n            return {\n                bam,\n                sequenceAdapter: adapter.dataAdapter,\n            };\n        }\n        return { bam };\n    }\n}\n"],"names":["concat","arr","opts","res","chunk","url","headers","Buffer","referer","rest","elt","unzip","HtsgetFile","BamFile","args","chr","min","max","_a","chrId","result","data","uncba","BAM_MAGIC","headLen","headerText","samHeader","parseHeaderText","idToName","nameToId","sqLines","l","refId","sqLine","refName","length","item","HtsgetBamAdapter","BamAdapter","htsgetBase","htsgetTrackId","bam","adapterConfig","adapter"],"mappings":"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","x_google_ignoreList":[0,1]}