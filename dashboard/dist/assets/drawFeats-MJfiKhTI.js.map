{"version":3,"file":"drawFeats-MJfiKhTI.js","sources":["../../node_modules/@jbrowse/plugin-alignments/esm/LinearReadArcsDisplay/drawFeats.js"],"sourcesContent":["import { getContainingView, getSession } from '@jbrowse/core/util';\nimport { featurizeSA } from '../MismatchParser';\nimport { getPairedInsertSizeAndOrientationColor, getPairedInsertSizeColor, getPairedOrientationColor, } from '../shared/color';\nimport { hasPairedReads } from '../shared/util';\nfunction jitter(n) {\n    return Math.random() * 2 * n - n;\n}\nfunction drawLineAtOffset(ctx, offset, height, color) {\n    ctx.strokeStyle = color;\n    ctx.beginPath();\n    ctx.moveTo(offset, 0);\n    ctx.lineTo(offset, height);\n    ctx.stroke();\n}\nexport function drawFeats(self, ctx, width, height) {\n    const { chainData, colorBy, drawInter, drawLongRange, lineWidthSetting, jitterVal, } = self;\n    if (!chainData) {\n        return;\n    }\n    const view = getContainingView(self);\n    const { assemblyManager } = getSession(self);\n    const { chains, stats } = chainData;\n    const hasPaired = hasPairedReads(chainData);\n    const asm = assemblyManager.get(view.assemblyNames[0]);\n    const type = (colorBy === null || colorBy === void 0 ? void 0 : colorBy.type) || 'insertSizeAndOrientation';\n    if (!asm) {\n        return;\n    }\n    ctx.lineWidth = lineWidthSetting;\n    function draw(k1, k2, assembly, longRange) {\n        var _a, _b, _c;\n        const s1 = k1.strand;\n        const s2 = k2.strand;\n        const f1 = s1 === -1;\n        const f2 = s2 === -1;\n        const p1 = f1 ? k1.start : k1.end;\n        const p2 = hasPaired ? (f2 ? k2.start : k2.end) : f2 ? k2.end : k2.start;\n        const ra1 = assembly.getCanonicalRefName(k1.refName) || k1.refName;\n        const ra2 = assembly.getCanonicalRefName(k2.refName) || k2.refName;\n        const r1 = (_a = view.bpToPx({ refName: ra1, coord: p1 })) === null || _a === void 0 ? void 0 : _a.offsetPx;\n        const r2 = (_b = view.bpToPx({ refName: ra2, coord: p2 })) === null || _b === void 0 ? void 0 : _b.offsetPx;\n        if (r1 !== undefined && r2 !== undefined) {\n            const radius = (r2 - r1) / 2;\n            const absrad = Math.abs(radius);\n            const p = r1 - view.offsetPx;\n            const p2 = r2 - view.offsetPx;\n            const drawArcInsteadOfBezier = absrad > 10000;\n            if (longRange && drawArcInsteadOfBezier) {\n                ctx.moveTo(p, 0);\n                ctx.beginPath();\n            }\n            else {\n                ctx.beginPath();\n                ctx.moveTo(p, 0);\n            }\n            if (longRange && drawArcInsteadOfBezier) {\n                ctx.strokeStyle = 'red';\n            }\n            else {\n                if (hasPaired) {\n                    if (type === 'insertSizeAndOrientation') {\n                        ctx.strokeStyle = getPairedInsertSizeAndOrientationColor(k1, k2, stats)[0];\n                    }\n                    else if (type === 'orientation') {\n                        ctx.strokeStyle = getPairedOrientationColor(k1)[0];\n                    }\n                    else if (type === 'insertSize') {\n                        ctx.strokeStyle =\n                            ((_c = getPairedInsertSizeColor(k1, k2, stats)) === null || _c === void 0 ? void 0 : _c[0]) || 'grey';\n                    }\n                    else if (type === 'gradient') {\n                        ctx.strokeStyle = `hsl(${Math.log10(absrad) * 10},50%,50%)`;\n                    }\n                }\n                else {\n                    if (type === 'orientation' || type === 'insertSizeAndOrientation') {\n                        if (s1 === -1 && s2 === 1) {\n                            ctx.strokeStyle = 'navy';\n                        }\n                        else if (s1 === 1 && s2 === -1) {\n                            ctx.strokeStyle = 'green';\n                        }\n                        else {\n                            ctx.strokeStyle = 'grey';\n                        }\n                    }\n                    else if (type === 'gradient') {\n                        ctx.strokeStyle = `hsl(${Math.log10(absrad) * 10},50%,50%)`;\n                    }\n                }\n            }\n            const destX = p + radius * 2;\n            const destY = Math.min(height + jitter(jitterVal), absrad);\n            if (longRange) {\n                if (absrad > 100000) {\n                    drawLineAtOffset(ctx, p + jitter(jitterVal), height, 'red');\n                    drawLineAtOffset(ctx, p2 + jitter(jitterVal), height, 'red');\n                }\n                else if (drawArcInsteadOfBezier) {\n                    ctx.arc(p + radius + jitter(jitterVal), 0, absrad, 0, Math.PI);\n                    ctx.stroke();\n                }\n                else {\n                    ctx.bezierCurveTo(p + jitter(jitterVal), destY, destX, destY, destX + jitter(jitterVal), 0);\n                    ctx.stroke();\n                }\n            }\n            else {\n                ctx.bezierCurveTo(p + jitter(jitterVal), destY, destX, destY, destX + jitter(jitterVal), 0);\n                ctx.stroke();\n            }\n        }\n        else if (r1 && drawInter) {\n            drawLineAtOffset(ctx, r1 - view.offsetPx, height, 'purple');\n        }\n    }\n    for (const chain of chains) {\n        if (chain.length === 1 && drawLongRange) {\n            const f = chain[0];\n            if (hasPaired && !(f.flags & 8)) {\n                const mate = {\n                    refName: f.next_ref || '',\n                    start: f.next_pos || 0,\n                    end: f.next_pos || 0,\n                    strand: f.strand,\n                };\n                draw(f, mate, asm, true);\n            }\n            else {\n                const features = [f, ...featurizeSA(f.SA, f.id, f.strand, f.name)].sort((a, b) => a.clipPos - b.clipPos);\n                for (let i = 0; i < features.length - 1; i++) {\n                    const f = features[i];\n                    const v1 = features[i + 1];\n                    draw(f, v1, asm, true);\n                }\n            }\n        }\n        else {\n            const res = hasPaired\n                ? chain.filter(f => !(f.flags & 2048) && !(f.flags & 8))\n                : chain\n                    .sort((a, b) => a.clipPos - b.clipPos)\n                    .filter(f => !(f.flags & 256));\n            for (let i = 0; i < res.length - 1; i++) {\n                draw(res[i], res[i + 1], asm, false);\n            }\n        }\n    }\n}\n"],"names":["jitter","drawLineAtOffset","ctx","offset","height","color","drawFeats","self","width","chainData","colorBy","drawInter","drawLongRange","lineWidthSetting","jitterVal","view","getContainingView","assemblyManager","getSession","chains","stats","hasPaired","hasPairedReads","asm","type","draw","k1","k2","assembly","longRange","_a","_b","_c","s1","s2","f1","f2","p1","p2","ra1","ra2","r1","r2","radius","absrad","p","drawArcInsteadOfBezier","getPairedInsertSizeAndOrientationColor","getPairedOrientationColor","getPairedInsertSizeColor","destX","destY","chain","f","mate","features","featurizeSA","a","b","i","v1","res"],"mappings":"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","x_google_ignoreList":[0]}